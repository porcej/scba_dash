{% extends "base.html" %}

{% block title %}Dashboard - SCBA Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
    </div>
</div>

<div class="row mt-3">
    <!-- Tasks Section -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Recent Tasks</h5>
            </div>
            <div class="card-body">
                {% if recent_tasks %}
                <div class="list-group" id="dashboard-tasks-list">
                    {% for task in recent_tasks %}
                    <div class="list-group-item" data-task-id="{{ task.id }}">
                        <div class="form-check">
                            <input class="form-check-input dashboard-task-checkbox" 
                                   type="checkbox" 
                                   data-task-id="{{ task.id }}"
                                   {% if task.completed %}checked disabled{% endif %}
                                   onchange="toggleDashboardTask({{ task.id }})">
                            <label class="form-check-label {% if task.completed %}text-decoration-line-through text-muted{% endif %}">
                                {{ task.content }}
                            </label>
                        </div>
                        <small class="text-muted">{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('main.tasks') }}" class="btn btn-sm btn-outline-primary">
                        View All Tasks <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                {% else %}
                <p class="text-muted">No tasks yet. <a href="{{ url_for('main.tasks') }}">Create your first task</a>!</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Gear List Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> SCBA Gear List</h5>
            </div>
            <div class="card-body" id="gear-list-container">
                <div id="gear-list-table-container" class="table-responsive" style="max-height: 550px; overflow-y: auto;">
                    <table class="table table-striped table-hover table-sm" id="gear-list-table">
                        <thead>
                            <tr>
                                <th>Type &mp; Model</th>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Location</th>
                                <th> </th>
                                <th>Due</th>
                            </tr>
                        </thead>
                        <tbody id="gear-list-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Loading gear list...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scraped Data Section -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-download"></i> SCBA Alerts</h5>
            </div>
            <div class="card-body" id="scraped-data-container" style="display: flex; flex-direction: column; padding: 0; height: calc(100vh - 250px);">
                {% if scraped_data %}
                    {% if scraped_data.status == 'success' and scraped_data.data %}
                        <div id="alerts-table-container" class="table-responsive" style="height: 100%; overflow-y: auto; flex: 1;">
                            <table class="table table-striped table-hover table-sm" id="alerts-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Internal ID</th>
                                        <th>Equipment</th>
                                        <th>Alert Text</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Opened By</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    {% elif scraped_data.error_details and scraped_data.error_details is iterable %}
                        {# Handle case where data is in error_details (from recent changes) #}
                        <div id="alerts-table-container" class="table-responsive" style="height: 100%; overflow-y: auto; flex: 1;">
                            <table class="table table-striped table-hover table-sm" id="alerts-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Internal ID</th>
                                        <th>Equipment</th>
                                        <th>Alert Text</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Opened By</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-warning" style="margin: 1rem;">
                            <strong>Status:</strong> {{ scraped_data.status or 'Unknown' }}<br>
                            {% if scraped_data.error %}
                                <strong>Error:</strong> {{ scraped_data.error }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted" style="margin: 1rem;">No scraped data available yet. Configure credentials in <a href="{{ url_for('main.settings') }}">Settings</a> to start scraping.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize alerts data from server
    var initialAlertsData = null;
    {% if scraped_data %}
        {% if scraped_data.status == 'success' and scraped_data.data %}
            initialAlertsData = {{ scraped_data.data.data | tojson | safe }};
        {% elif scraped_data.error_details %}
            {% if scraped_data.error_details is iterable and scraped_data.error_details is not string %}
                initialAlertsData = {{ scraped_data.error_details | tojson | safe }};
            {% endif %}
        {% endif %}
    {% endif %}
    
    function renderAlertsTable(alertsData) {
        const tbody = document.getElementById('alerts-table-body');
        if (!tbody) return;
        
        // Clear existing rows
        tbody.innerHTML = '';
        
        if (!alertsData || !Array.isArray(alertsData) || alertsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No alerts found</td></tr>';
            return;
        }
        
        // Render each alert as a table row
        alertsData.forEach(function(alert) {
            const row = document.createElement('tr');
            
            // Format alert text - replace <br/> with newlines and preserve whitespace
            let alertText = alert.alert_text || '';
            // Replace <br/>, <br>, </br> and similar tags with newlines
            alertText = alertText.replace(/<br\s*\/?>/gi, '\n');
            // Remove other HTML tags (keep only text content)
            alertText = alertText.replace(/<[^>]+>/g, '');
            // HTML escape the text
            alertText = escapeHtml(alertText);
            // Convert newlines to <br> for display
            alertText = alertText.replace(/\n/g, '<br>');
            
            // Format alert comments - same processing as alert text
            let alertComments = alert.alertcomments || '';
            if (alertComments) {
                // Replace <br/>, <br>, </br> and similar tags with newlines
                alertComments = alertComments.replace(/<br\s*\/?>/gi, '\n');
                // Remove other HTML tags
                alertComments = alertComments.replace(/<[^>]+>/g, '');
                // HTML escape the text
                alertComments = escapeHtml(alertComments);
                // Convert newlines to <br> for display
                alertComments = alertComments.replace(/\n/g, '<br>');
                // Add separator and format comments (theme-aware color)
                const commentColor = document.documentElement.getAttribute('data-theme') === 'dark' ? '#adb5bd' : '#6c757d';
                alertText += '<br><br><em style="color: ' + commentColor + '; font-size: 0.9em;"><strong>Comments:</strong><br>' + alertComments + '</em>';
            }
            
            // Format date
            const alertDate = alert.alert_date || '';
            
            // Equipment name (combine equip_name and model/mfr if available)
            let equipment = alert.equip_name || '';
            if (alert.model) {
                equipment += (equipment ? ' - ' : '') + alert.model;
            }
            if (!equipment && alert.internal_id) {
                equipment = alert.internal_id;
            }
            
            row.innerHTML = `
                <td>${escapeHtml(alertDate)}</td>
                <td><strong>${escapeHtml(alert.internal_id || 'N/A')}</strong></td>
                <td>${escapeHtml(equipment || 'N/A')}</td>
                <td style="white-space: normal; word-wrap: break-word;">${alertText}</td>
                <td><span class="badge ${getStatusBadgeClass(alert.status_text)}">${escapeHtml(alert.status_text || 'N/A')}</span></td>
                <td>${escapeHtml(alert.priority || 'N/A')}</td>
                <td>${escapeHtml(alert.openedby || 'N/A')}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getStatusBadgeClass(status) {
        if (!status) return 'bg-secondary';
        status = status.toLowerCase();
        if (status === 'active') return 'bg-danger';
        if (status === 'cache') return 'bg-warning';
        if (status === 'closed') return 'bg-success';
        return 'bg-secondary';
    }
    
    function extractAlertsData(data) {
        // Try to extract alerts array from various possible data structures
        if (!data) return null;
        
        // Case 1: data.data is the alerts array
        if (data.data && Array.isArray(data.data)) {
            return data.data;
        }
        
        // Case 2: data.error_details is the alerts array (from recent scraper changes)
        if (data.error_details && Array.isArray(data.error_details)) {
            return data.error_details;
        }
        
        // Case 3: data itself is the array
        if (Array.isArray(data)) {
            return data;
        }
        
        // Case 4: nested structure
        if (data.data && data.data.data && Array.isArray(data.data.data)) {
            return data.data.data;
        }
        
        return null;
    }
    
    // Function to update scraped data on SocketIO updates
    window.updateScrapedDataFunction = function(data) {
        const container = document.getElementById('scraped-data-container');
        if (!container) return;
        
        // Extract alerts array from data
        const alertsData = extractAlertsData(data);
        
        if (alertsData) {
            // Ensure container has flex styling
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.padding = '0';
            container.style.height = 'calc(100vh - 250px)';
            
            // Update container to show table if needed
            if (!container.querySelector('#alerts-table-container')) {
                container.innerHTML = `
                    <div id="alerts-table-container" class="table-responsive" style="height: 100%; overflow-y: auto; flex: 1;">
                        <table class="table table-striped table-hover table-sm" id="alerts-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Internal ID</th>
                                    <th>Equipment</th>
                                    <th>Alert Text</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Opened By</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-table-body"></tbody>
                        </table>
                    </div>
                `;
            }
            
            renderAlertsTable(alertsData);
        } else if (data && data.status) {
            // Show error or status message
            container.style.display = 'block';
            container.style.padding = '1rem';
            const statusClass = data.status === 'error' ? 'alert-danger' : 'alert-warning';
            container.innerHTML = `
                <div class="alert ${statusClass}">
                    <strong>Status:</strong> ${escapeHtml(data.status)}<br>
                    ${data.error ? '<strong>Error:</strong> ' + escapeHtml(data.error) : ''}
                </div>
            `;
        }
    };
    
    // Gear List Functions
    function formatDate(dateDisplay) {
        if (!dateDisplay || dateDisplay === '') return 'N/A';
        return escapeHtml(dateDisplay);
    }
    
    function parseDateString(dateStr) {
        // Parse date string in MM/DD/YYYY format
        if (!dateStr || dateStr === '') return null;
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const month = parseInt(parts[0], 10) - 1; // JavaScript months are 0-indexed
            const day = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
        return null;
    }
    
    function isOverdue(dateStr) {
        // Check if date is today or in the past
        const date = parseDateString(dateStr);
        if (!date) return false;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day
        date.setHours(0, 0, 0, 0); // Reset time to start of day
        
        return date <= today;
    }
    
    function parseLocation(locationObj) {
        if (!locationObj || !locationObj.display) return 'N/A';
        // Format: "10/28/2025 | EMS 201-EMS 201-MMR "
        // Extract everything after the "|" and trim
        const parts = locationObj.display.split('|');
        if (parts.length > 1) {
            return parts[1].trim();
        }
        return locationObj.display.trim();
    }
    
    function getSortValue(item, fieldPath) {
        // Handle nested objects like nextdue.nxtsort
        const parts = fieldPath.split('.');
        let value = item;
        for (let part of parts) {
            if (value && typeof value === 'object') {
                value = value[part];
            } else {
                return '';
            }
        }
        return value || '';
    }
    
    function renderGearListTable(gearData) {
        const tbody = document.getElementById('gear-list-table-body');
        if (!tbody) return;
        
        // Clear existing rows
        tbody.innerHTML = '';
        
        // Extract data array from response structure
        let gearArray = null;
        if (gearData && gearData.data && Array.isArray(gearData.data)) {
            gearArray = gearData.data;
        } else if (Array.isArray(gearData)) {
            gearArray = gearData;
        }
        
        if (!gearArray || gearArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No gear found</td></tr>';
            return;
        }
        
        // Sort by "next due" date in ascending order (earliest dates first)
        gearArray.sort(function(a, b) {
            const aSort = getSortValue(a, 'nextdue.nxtsort') || '';
            const bSort = getSortValue(b, 'nextdue.nxtsort') || '';
            
            // Empty values go to the end
            if (!aSort && !bSort) return 0;
            if (!aSort) return 1;
            if (!bSort) return -1;
            
            // Parse dates for proper comparison
            // nxtsort format is MM/DD/YYYY
            function parseDate(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // MM/DD/YYYY format
                    const month = parseInt(parts[0], 10) - 1; // JavaScript months are 0-indexed
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day);
                }
                // Fallback: try standard Date parsing
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            
            const aDate = parseDate(aSort);
            const bDate = parseDate(bSort);
            
            // If both dates are valid, compare them
            if (aDate && bDate) {
                return aDate.getTime() - bDate.getTime(); // Ascending order (earliest first)
            }
            
            // If one date is invalid, put it at the end
            if (!aDate && !bDate) return 0;
            if (!aDate) return 1;
            if (!bDate) return -1;
            
            // Fallback to string comparison if date parsing fails
            return aSort.localeCompare(bSort);
        });
        
        // Render each gear item as a table row
        gearArray.forEach(function(gear) {
            const row = document.createElement('tr');
            
            // Extract values directly from the gear object structure
            const type = gear.geartype || '';
            const model = gear.model || '';
            const serialNumber = gear.serial || '';
            const id = gear.internalid || '';
            const description = gear.description || 'N/A';
            const location = parseLocation(gear.lastloglocation);
            const nextHydro = gear.nexthydro ? (gear.nexthydro.hydrosort || '') : '';
            const nextFlow = gear.nextflow ? (gear.nextflow.flowsort || '') : '';
            const nextDo = gear.nextdue ? (gear.nextdue.display || '') : '';
            
            // Format type and model with line break and muted model text
            let typeModelHtml = '';
            if (type && model) {
                typeModelHtml = `${escapeHtml(type)}<br><span class="text-muted" style="font-size: 0.9em;">${escapeHtml(model)}</span>`;
            } else if (type) {
                typeModelHtml = escapeHtml(type);
            } else if (model) {
                typeModelHtml = `<span class="text-muted" style="font-size: 0.9em;">${escapeHtml(model)}</span>`;
            } else {
                typeModelHtml = 'N/A';
            }
            
            // Format ID and Serial Number with line break and muted serial text
            let idSerialHtml = '';
            if (id && serialNumber) {
                idSerialHtml = `<strong>${escapeHtml(id)}</strong><br><span class="text-muted" style="font-size: 0.9em;">${escapeHtml(serialNumber)}</span>`;
            } else if (id) {
                idSerialHtml = `<strong>${escapeHtml(id)}</strong>`;
            } else if (serialNumber) {
                idSerialHtml = `<span class="text-muted" style="font-size: 0.9em;">${escapeHtml(serialNumber)}</span>`;
            } else {
                idSerialHtml = '';
            }
            
            // Check if dates are overdue for badge highlighting
            const nextDoDisplay = gear.nextdue ? (gear.nextdue.display || '') : '';
            const nextHydroDisplay = gear.nexthydro ? (gear.nexthydro.display || '') : '';
            const nextFlowDisplay = gear.nextflow ? (gear.nextflow.display || '') : '';
            
            const isNextDoOverdue = isOverdue(nextDoDisplay);
            const isNextHydroOverdue = isOverdue(nextHydroDisplay);
            const isNextFlowOverdue = isOverdue(nextFlowDisplay);
            
            // Format Next Due with badges for overdue dates
            let nextDueHtmlFormatted = '';
            if (nextHydro && nextFlow) {
                const hydroFormatted = formatDate(nextHydro);
                const flowFormatted = formatDate(nextFlow);
                const hydroBadge = isNextHydroOverdue ? `<span class="badge bg-danger">${hydroFormatted}</span>` : hydroFormatted;
                const flowBadge = isNextFlowOverdue ? `<span class="badge bg-danger">${flowFormatted}</span>` : flowFormatted;
                nextDueHtmlFormatted = `Hydro: ${hydroBadge}<br>Flow: ${flowBadge}`;
            } else if (nextHydro) {
                const hydroFormatted = formatDate(nextHydro);
                const hydroBadge = isNextHydroOverdue ? `<span class="badge bg-danger">${hydroFormatted}</span>` : hydroFormatted;
                nextDueHtmlFormatted = `Hydro: ${hydroBadge}`;
            } else if (nextFlow) {
                const flowFormatted = formatDate(nextFlow);
                const flowBadge = isNextFlowOverdue ? `<span class="badge bg-danger">${flowFormatted}</span>` : flowFormatted;
                nextDueHtmlFormatted = `Flow: ${flowBadge}`;
            } else {
                nextDueHtmlFormatted = '';
            }
            
            // Format Next DO with badge if overdue
            let nextDoFormatted = formatDate(nextDo);
            if (isNextDoOverdue && nextDo !== 'N/A' && nextDo !== '') {
                nextDoFormatted = `<span class="badge bg-danger">${nextDoFormatted}</span>`;
            }
            
            row.innerHTML = `
                <td>${typeModelHtml}</td>
                <td>${idSerialHtml}</td>
                <td>${escapeHtml(description)}</td>
                <td>${escapeHtml(location)}</td>
                <td>${nextDueHtmlFormatted}</td>
                <td>${nextDoFormatted}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function loadGearList() {
        fetch('/api/gear-list')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    const tbody = document.getElementById('gear-list-table-body');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${escapeHtml(data.error)}</td></tr>`;
                    }
                } else if (data.data) {
                    renderGearListTable(data.data);
                }
            })
            .catch(error => {
                console.error('Error fetching gear list:', error);
                const tbody = document.getElementById('gear-list-table-body');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading gear list</td></tr>`;
                }
            });
    }
    
    // Initialize tables on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize alerts table
        if (initialAlertsData) {
            renderAlertsTable(initialAlertsData);
        }
        
        // Load gear list
        loadGearList();
        
        // Periodically refresh gear list
        setInterval(loadGearList, 60000); // Refresh every 60 seconds
    });
    
    // Periodically refresh scraped data
    setInterval(function() {
        fetch('/api/scrape-data')
            .then(response => response.json())
            .then(data => {
                const alertsData = extractAlertsData(data);
                if (alertsData || (data && data.status)) {
                    window.updateScrapedDataFunction(data);
                }
            })
            .catch(error => console.error('Error fetching scrape data:', error));
    }, 30000); // Refresh every 30 seconds
    
    // Real-time dashboard task updates
    window.updateDashboardTasks = function(data) {
        const tasksContainer = document.querySelector('#dashboard-tasks-list') || document.querySelector('.list-group');
        if (!tasksContainer) return;
        
        // Verify this is the Recent Tasks section
        const cardHeader = tasksContainer.closest('.card')?.querySelector('.card-header h5');
        if (!cardHeader || !cardHeader.textContent.includes('Recent Tasks')) {
            return; // Not the Recent Tasks section
        }
        
        if (data.action === 'deleted' || (data.action === 'completed' && data.completed)) {
            // Remove completed or deleted tasks from dashboard
            const taskItem = tasksContainer.querySelector(`[data-task-id="${data.id}"]`);
            if (taskItem) {
                taskItem.remove();
                // Check if we need to show "no tasks" message
                if (tasksContainer.children.length === 0) {
                    const cardBody = tasksContainer.closest('.card-body');
                    if (cardBody) {
                        tasksContainer.outerHTML = '<p class="text-muted m-0">No incomplete tasks.</p>';
                    }
                }
            }
            return;
        }
        
        if (data.action === 'added' && !data.completed) {
            // Add new incomplete task to dashboard
            // Find the list-group container or create it
            let listContainer = document.querySelector('#dashboard-tasks-list');
            if (!listContainer) {
                const cardBody = document.querySelector('.card-body');
                const noTasksMsg = cardBody.querySelector('.text-muted');
                if (noTasksMsg && noTasksMsg.textContent.includes('No tasks')) {
                    noTasksMsg.remove();
                    listContainer = document.createElement('div');
                    listContainer.className = 'list-group';
                    listContainer.id = 'dashboard-tasks-list';
                    cardBody.insertBefore(listContainer, cardBody.firstChild);
                } else {
                    return; // Can't find container
                }
            }
            
            const taskElement = createDashboardTaskElement(data);
            listContainer.insertBefore(taskElement, listContainer.firstChild);
            // Keep only 5 most recent
            while (listContainer.children.length > 5) {
                listContainer.removeChild(listContainer.lastChild);
            }
            return;
        }
        
        if (data.action === 'uncompleted' && !data.completed) {
            // Add task back if it was uncompleted
            let listContainer = document.querySelector('#dashboard-tasks-list');
            if (!listContainer) {
                // Create list container if it doesn't exist
                const cardBody = document.querySelector('.card-body');
                const noTasksMsg = cardBody.querySelector('.text-muted');
                if (noTasksMsg) {
                    noTasksMsg.remove();
                }
                listContainer = document.createElement('div');
                listContainer.className = 'list-group';
                listContainer.id = 'dashboard-tasks-list';
                cardBody.insertBefore(listContainer, cardBody.firstChild);
            }
            
            const existingTask = listContainer.querySelector(`[data-task-id="${data.id}"]`);
            if (!existingTask) {
                const taskElement = createDashboardTaskElement(data);
                listContainer.insertBefore(taskElement, listContainer.firstChild);
                // Keep only 5 most recent
                while (listContainer.children.length > 5) {
                    listContainer.removeChild(listContainer.lastChild);
                }
            }
            return;
        }
    };
    
    function toggleDashboardTask(taskId) {
        fetchWithCSRF(`/tasks/${taskId}/toggle`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.completed) {
                // Immediately remove the task from dashboard when completed
                const tasksContainer = document.querySelector('#dashboard-tasks-list');
                if (tasksContainer) {
                    const taskItem = tasksContainer.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskItem) {
                        taskItem.remove();
                        // Check if we need to show "no tasks" message
                        if (tasksContainer.children.length === 0) {
                            const cardBody = tasksContainer.closest('.card-body');
                            if (cardBody) {
                                const existingP = cardBody.querySelector('.text-muted');
                                if (!existingP || !existingP.textContent.includes('No')) {
                                    const noTasksP = document.createElement('p');
                                    noTasksP.className = 'text-muted m-0';
                                    noTasksP.textContent = 'No incomplete tasks.';
                                    cardBody.insertBefore(noTasksP, cardBody.firstChild);
                                }
                                tasksContainer.remove();
                            }
                        }
                    }
                }
            }
            // Task will also be updated via Socket.IO event for consistency
        })
        .catch(error => console.error('Error toggling task:', error));
    }
    
    function createDashboardTaskElement(task) {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'list-group-item';
        taskDiv.setAttribute('data-task-id', task.id);
        
        const dateStr = task.created_at ? new Date(task.created_at).toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }) : '';
        
        taskDiv.innerHTML = `
            <div class="form-check">
                <input class="form-check-input dashboard-task-checkbox" 
                       type="checkbox" 
                       data-task-id="${task.id}"
                       onchange="toggleDashboardTask(${task.id})">
                <label class="form-check-label">${escapeHtml(task.content)}</label>
            </div>
            <small class="text-muted">${dateStr}</small>
        `;
        
        return taskDiv;
    }
</script>
{% endblock %}

